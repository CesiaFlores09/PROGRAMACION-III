<div class="card text-white bg-secondary mb-3" id="cardReceta">
    <div class="card-header"style="text-align: center;">(REGISTRO) DATOS RECETAS
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" data-bs-target="#cardReceta" aria-label="Close"></button></div>
    <div class="card-body">
        <form id="frmRegistrarReceta" data-accion="nuevo" data-codigoreceta="0" class="row g-2">
           <div class="form-group col-md-6">
                <label for="cboPacienteReceta">Paciente</label>
                <select id="cboPacienteReceta" name="cboPacienteReceta" class="form-control form-control-sm">
                    
                </select>
            </div>
            <div class="form-group col-md-6">
                <label for="cboMedicoReceta">Médico</label>
                <select id="cboMedicoReceta" name="cboMedicoReceta" class="form-control form-control-sm">
                    
                </select>
            </div>
            <div class="form-group col-md-6">
                <label for="cboMedicamentosReceta">Medicamentos</label>
                <select id="cboMedicamentosReceta" class="form-control form-control-sm" name="cboMedicamentosReceta" required multiple>
                   
                </select>
            </div>
            <div class="form-group col-md-6">
                <label for="txtObservacionesReceta">Observaciones</label>
                <textarea id="txtObservacionesReceta" name="txtObservacionesReceta" class="form-control form-control-sm" rows="3"></textarea>
            </div>
            <div class="col-auto">
                <button id="btnRegistrarReceta" type="submit" class="btn btn-success mb-3" style="border-radius: 10px; margin-top: 14px; color: black; border-color: green;">Registrar</button>
                <button type="reset" class="btn btn-warning mb-3" style="border-radius: 10px; margin-top: 14px; color: black; border-color: yellow;">Nuevo</button>
                <button type="button" class="btn btn-success mb-3" id="btnBuscarReceta" style="border-radius: 10px; margin-top: 14px; color: black; border-color: green;">Buscar</button>
            </div>
        </form>
        <div class="row g-2">
            <div class="col-auto" id="alerta">
                <div class="alert alert-success alert-dismissible fade show d-none" role="alert" id="msgReceta">
                    <strong></strong> <span></span>
                    <button type="button" class="btn" data-bs-dismiss="alert" aria-label="Close">
                       X
                    </button>
                </div>
            </div>
        </div>
    </div>
  </div>
  <script>
      function consultarPersonalReceta() {
          $.get("http://localhost:3008/consultar-personal", (respuesta, status) => {
              console.log(respuesta);
              let cboPersonal = $("#cboMedicoReceta");
              cboPersonal.empty();
              cboPersonal.append("<option value=''>Seleccione un Personal</option>");
               if(respuesta.resp.length>0){
                    respuesta.resp.forEach(personal => {
                        cboPersonal.append("<option value='" + personal.idPersonal + "'>" + personal.Nombre + "</option>");
                    });
                }
          }, "json");
          
      }
      function consultarPacienteReceta() {
          $.get("http://localhost:3008/consultar-paciente", (respuesta, status) => {
              console.log(respuesta);
              let cboPaciente = $("#cboPacienteReceta");
              cboPaciente.empty();
              cboPaciente.append("<option value=''>Seleccione un Paciente</option>");
               if(respuesta.resp.length>0){
                    respuesta.resp.forEach(paciente => {
                        cboPaciente.append("<option value='" + paciente.idPaciente + "'>" + paciente.Nombre + "</option>");
                    });
                }
            }, "json");
      }
      function consultarMedicamentosReceta() {
            $.get("http://localhost:3008/consultar-medicamento", (respuesta, status) => {
                console.log(respuesta);
                let cboMedicamento = $("#cboMedicamentosReceta");
                cboMedicamento.empty();
                 if(respuesta.resp.length>0){
                        respuesta.resp.forEach(medicamento => {
                            cboMedicamento.append("<option value='" + medicamento.idMedicamento + "'>" + medicamento.Nombre + "</option>");
                        });
                    }
                }, "json");
      }
      function mostrarReceta(receta){
        $("#frmRegistrarReceta")
            .data("accion","modificar")
            .data("codigoreceta",receta.idReceta);
        $("#cboMedicoReceta").val(receta.idPersonal);
        $("#cboPacienteReceta").val(receta.idPaciente);
        console.log(receta);
        let medicamentos = receta.idMedicamentos.split(",");
        $("#cboMedicamentosReceta").val(medicamentos);
        $("#txtObservacionesReceta").val(receta.Detalles);
        }
      
        function limpiarDatosReceta(receta){
            $("#frmRegistrarReceta")
                .data("accion","nuevo")
                .data("codigoreceta",0);
            $("#cboMedicoReceta").val("");
            $("#cboPacienteReceta").val("");
            $("#cboMedicamentosReceta").val("");
            $("#txtObservacionesReceta").val("");
        }

            $(document).ready(function(){
                consultarPersonalReceta();
                consultarPacienteReceta();
                consultarMedicamentosReceta();
                
            $("#btnBuscarReceta").click(function(ev){
                ev.preventDefault();
                abrir_ventana("recetas", "buscar");
        });

                $('#frmRegistrarReceta').submit(e => {
                    e.preventDefault();
                    let accion = $("#frmRegistrarReceta").data("accion"),
                        id = $("#frmRegistrarReceta").data("codigoreceta"),
                        idPersonal = $("#cboMedicoReceta").val(),
                        idPaciente = $("#cboPacienteReceta").val(),
                        medicamentos = $("#cboMedicamentosReceta").val(),
                        observaciones = $("#txtObservacionesReceta").val(),
                        data = {
                            'accion': accion,
                            'id': id,
                            'idPersonal': idPersonal,
                            'idPaciente': idPaciente,
                            'medicamentos': medicamentos,
                            'detalles': observaciones
                        };
                    console.log(data);
                    $.post('http://localhost:3008/receta', JSON.stringify(data), (respuesta, status) => {
                        if ( respuesta.resultado.indexOf("exito") >=0 ) {
                            $('#alerta').append(`<div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <strong>¡Exito!</strong> <span>${respuesta.resultado}</span>
                                    <button type="button" class="btn" data-bs-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">X</span>
                                    </button>
                                </div>`);
                                limpiarDatosReceta();
                                consultarRecetas();
                        } else {
                            $('#alerta').append(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <strong>¡Error!</strong> <span>${respuesta.resultado}</span>
                                    <button type="button" class="btn" data-bs-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">X</span>
                                    </button>
                                </div>`);
                        }
                    }, "json");
                })
                .on('reset', function(){
                    limpiarDatosReceta();
                });
            });
  </script>